<div class="diary-container">
  <div class="diary-header">
    <h3>{{ langService.t('diary.title') }}</h3>
    <div class="diary-actions">
      <button 
        (click)="exportToPDF()" 
        class="export-btn"
        title="Esporta tutto il diario in PDF"
      >
        {{ langService.t('diary.export') }}
      </button>
      <button 
        (click)="readCurrentPage()" 
        class="read-btn"
        [disabled]="visibleEntries().length === 0"
        title="Leggi pagina ad alta voce"
      >
        {{ langService.t('diary.read') }}
      </button>
      <button (click)="startWriting()" class="write-btn">{{ langService.t('diary.write') }}</button>
    </div>
  </div>

  <!-- Libro aperto -->
  <div 
    class="book" 
    [class.writing]="isWriting()"
    (touchstart)="onTouchStart($event)"
    (touchend)="onTouchEnd($event)"
    (wheel)="onWheel($event)"
  >
    <div class="book-pages">
      
            <!-- Pagina sinistra -->
            <div class="page left-page" *ngIf="visibleEntries()[0]; else emptyLeft">
              <div class="page-content">
                <div class="page-header">
                  <span class="page-date">{{ formatDate(visibleEntries()[0].data) }}</span>
                  <span class="page-mood">{{ getMoodEmoji(visibleEntries()[0].umore) }}</span>
                </div>
                <div class="page-text">{{ visibleEntries()[0].contenuto }}</div>
                <div class="page-tags" *ngIf="visibleEntries()[0]?.tags && visibleEntries()[0]?.tags?.length! > 0">
                  <span *ngFor="let tag of visibleEntries()[0]?.tags" class="tag">#{{ tag }}</span>
                </div>
                <div class="page-share">
                  <button (click)="condividiEntry(visibleEntries()[0])" class="share-btn">
                    {{ langService.t('diary.share') }}
                  </button>
                </div>
              </div>
            </div>
              <ng-template #emptyLeft>
                <div class="page left-page empty">
                  <div class="empty-message">
                    <p>üìù</p>
                    <p>{{ langService.t('diary.noPage') }}</p>
                  </div>
                </div>
              </ng-template>

      <!-- Divisore centrale -->
      <div class="book-spine"></div>

            <!-- Pagina destra -->
            <div class="page right-page" *ngIf="!isWriting()">
              <div class="page-content" *ngIf="visibleEntries()[1]; else emptyRight">
                <div class="page-header">
                  <span class="page-date">{{ formatDate(visibleEntries()[1].data) }}</span>
                  <span class="page-mood">{{ getMoodEmoji(visibleEntries()[1].umore) }}</span>
                </div>
                <div class="page-text">{{ visibleEntries()[1].contenuto }}</div>
                <div class="page-tags" *ngIf="visibleEntries()[1]?.tags && visibleEntries()[1]?.tags?.length! > 0">
                  <span *ngFor="let tag of visibleEntries()[1]?.tags" class="tag">#{{ tag }}</span>
                </div>
                <div class="page-share">
                  <button (click)="condividiEntry(visibleEntries()[1])" class="share-btn">
                    {{ langService.t('diary.share') }}
                  </button>
                </div>
              </div>
              <ng-template #emptyRight>
                <div class="empty-message">
                  <p>üìù</p>
                  <p>{{ langService.t('diary.noPage') }}</p>
                </div>
              </ng-template>
            </div>

      <!-- Pagina destra normale quando NON si scrive -->
      <div class="page right-page" *ngIf="isWriting()">
        <div class="empty-message">
          <p>‚úçÔ∏è</p>
          <p>Scrivi nella modale...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Controlli navigazione -->
  <div class="book-controls" *ngIf="!isWriting()">
    <button 
      (click)="previousPage()"
      [disabled]="!hasPreviousPage()"
      class="nav-book-btn"
    >
      {{ langService.t('diary.previous') }}
    </button>
    <span class="page-number">Pagina {{ currentPage() + 1 }}</span>
    <button 
      (click)="nextPage()"
      [disabled]="!hasNextPage()"
      class="nav-book-btn"
    >
      {{ langService.t('diary.next') }}
    </button>
  </div>
</div>

<!-- MODALE SCRITTURA SEPARATA (overlay completo) -->
<div *ngIf="isWriting()" class="write-modal-overlay" (click)="cancelWriting()">
  <div class="write-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ langService.t('diary.writeThought') }}</h3>
      <button (click)="cancelWriting()" class="modal-close">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="date-display">
        üìÖ {{ formatDate(formData) }}
      </div>

      <textarea
        [(ngModel)]="formContenuto"
        [placeholder]="langService.t('diary.placeholder')"
        class="modal-textarea"
        rows="10"
      ></textarea>

      <div class="modal-mic-container" *ngIf="speechService.isRecognitionSupported()">
        <button
          (click)="dettaNelDiario()"
          [disabled]="speechService.isListening()"
          class="modal-mic-btn"
          [class.listening]="speechService.isListening()"
        >
          <span *ngIf="!speechService.isListening()">üé§ Detta</span>
          <span *ngIf="speechService.isListening()">üî¥ Ascolto...</span>
        </button>
      </div>

      <div class="mood-section">
        <label>{{ langService.t('diary.howDoYouFeel') }}</label>
        <div class="mood-buttons">
          <button
            *ngFor="let mood of moods"
            (click)="setMood(mood)"
            [class.selected]="formUmore === mood"
            class="mood-option"
          >
            {{ getMoodEmoji(mood) }}
          </button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="cancelWriting()" class="modal-btn-cancel">
        {{ langService.t('diary.cancel') }}
      </button>
      <button (click)="saveEntry()" class="modal-btn-save">
        {{ langService.t('diary.save') }}
      </button>
    </div>
  </div>
</div>
